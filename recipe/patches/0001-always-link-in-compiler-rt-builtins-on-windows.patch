From 47fe5eea99a188f7373bee4d7ff6d8ff7e8c8698 Mon Sep 17 00:00:00 2001
From: "H. Vetinari" <h.vetinari@gmx.com>
Date: Mon, 17 Apr 2023 23:38:48 +1100
Subject: [PATCH] always link in compiler-rt builtins on windows

don't abort in find_compiler_rt_library if compiler isn't clang,
clang can be available without being the CMAKE_CXX_COMPILER.
---
 flang/CMakeLists.txt | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/flang/CMakeLists.txt b/flang/CMakeLists.txt
index b048ea220e..31435737dc 100644
--- a/flang/CMakeLists.txt
+++ b/flang/CMakeLists.txt
@@ -46,9 +46,10 @@ endif()
 include(GNUInstallDirs)
 
 # MSVC + clang-cl build requires clang_rt.builtin.${target} library
-if (MSVC AND CMAKE_CXX_COMPILER_ID MATCHES Clang)
-  include(HandleCompilerRT)
-  find_compiler_rt_library(builtins CLANG_RT_BUILTINS_LIBRARY)
+if (MSVC)
+  cmake_path(SET CLANG_RT_BUILTINS_LIBRARY
+             NORMALIZE
+             "$ENV{LIBRARY_LIB}/clang/$ENV{PKG_VERSION}/lib/windows/clang_rt.builtins-x86_64.lib")
   get_filename_component(LIBDIR "${CLANG_RT_BUILTINS_LIBRARY}" DIRECTORY)
   if (IS_DIRECTORY "${LIBDIR}")
     link_libraries(${CLANG_RT_BUILTINS_LIBRARY})
-- 
2.38.1.windows.1

