{% set version = "17.0.1" %}

package:
  name: flang-split
  version: {{ version }}

source:
  url: https://github.com/llvm/llvm-project/releases/download/llvmorg-{{ version.replace(".rc", "-rc") }}/llvm-project-{{ version.replace(".rc", "rc") }}.src.tar.xz
  sha256: b0e42aafc01ece2ca2b42e3526f54bebc4b1f1dc8de6e34f46a0446a13e882b9
  patches:
    # link compiler-rt libs (upstream's find_compiler_rt_library doesn't work correctly);
    # probably related to https://github.com/llvm/llvm-project/issues/63286
    # - patches/0001-always-link-in-compiler-rt-builtins-on-windows-apple.patch
    # backport https://reviews.llvm.org/D154660
    - patches/0002-flang-Allow-runtime-build-with-AVOID_NATIVE_INT128_T.patch

build:
  number: 0
  # intentionally only x64 builds; win (main target), linux (debuggability)
  # plus osx to be able to test a consistent llvm stack not just on windows.
  track_features:
    - flang

requirements:
  build:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - cmake
    - ninja
    - sysroot_linux-64 ==2.17  # [linux64]
    - mlir =={{ version }}     # [build_platform != target_platform]
  host:
    - clangdev =={{ version }}
    - compiler-rt =={{ version }}
    - lit =={{ version }}
    - llvm-openmp =={{ version }}
    - llvmdev =={{ version }}
    - mlir =={{ version }}
    - zlib

test:
  commands:
    - flang --version

outputs:
  - name: libflang
    script: install_libflang.sh  # [unix]
    script: install_libflang.bat  # [win]
    requirements:
      build:
        # for strong run-exports
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
      host:
        - clangdev =={{ version }}
        - compiler-rt =={{ version }}
        - llvmdev =={{ version }}
        - mlir =={{ version }}
      run:
        # necessary to link on windows (even for static lib), e.g.
        # FortranDecimal.lib(binary-to-decimal.cpp.obj) : error LNK2019: unresolved external symbol __udivti3 ...
        - compiler-rt =={{ version }}  # [win]
    test:
      commands:
        # shared lib on linux
        - test -f $PREFIX/lib/libFortranRuntime.so              # [linux]
        # static lib on osx (segfaults with shared ones)
        - test -f $PREFIX/lib/libFortranRuntime.a               # [osx]
        # static lib on win (fails to export symbols for shared build)
        - if not exist %LIBRARY_LIB%\FortranRuntime.lib exit 1  # [win]

  - name: libfortran-main
    script: install_libfortran_main.sh  # [unix]
    script: install_libfortran_main.bat  # [win]
    requirements:
      build:
        # if there's no build env, windows fails with EnvironmentLocationNotFound (what?!)
        - {{ compiler('c') }}    # [win]
        - {{ compiler('cxx') }}  # [win]
      host:
        # this is just here to have a non-empty host environment
        - {{ pin_subpackage('libflang', exact=True) }}
      run:
        # not sure what we need here
    test:
      commands:
        - test -f $PREFIX/lib/libFortran_main.a                 # [unix]
        - if not exist %LIBRARY_LIB%\Fortran_main.lib exit 1    # [win]

  - name: flang
    script: install_flang.sh  # [unix]
    script: install_flang.bat  # [win]
    run_exports:
      strong:
        - libflang >={{ version }}
    requirements:
      build:
        - cmake
        - ninja
        # for strong run-exports
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
      host:
        - clangdev =={{ version }}
        - compiler-rt =={{ version }}
        - llvm-openmp =={{ version }}
        - llvmdev =={{ version }}
        - mlir =={{ version }}
        # for required run-exports
        - llvm =={{ version }}
        - libclang-cpp =={{ version }}
        # ninja really wants to find z.lib on win
        - zlib  # [win]
        - {{ pin_subpackage('libflang', exact=True) }}
        - {{ pin_subpackage('libfortran-main', exact=True) }}
      run:
        - sysroot_{{ target_platform }} ==2.17  # [linux]
        - clangdev =={{ version }}
        - llvm-openmp =={{ version }}
        - {{ pin_subpackage('libflang', exact=True) }}
        - {{ pin_subpackage('libfortran-main', exact=True) }}
    test:
      requires:
        - {{ compiler('c') }}       # [win]
        - {{ compiler('cxx') }}     # [win]
      files:
        - hello_world.f90
      commands:
        # see naming discussion: https://discourse.llvm.org/t/reviving-rename-flang-new-to-flang/68130/2
        # - flang hello_world.f90
        - flang-new hello_world.f90
        - ./a.out   # [unix]
        - a.exe     # [win]

  - name: flang_{{ target_platform }}
    run_exports:
      strong:
        - libflang >={{ version }}
    requirements:
      - {{ pin_subpackage('flang', exact=True) }}


about:
  home: https://flang.llvm.org
  license: Apache-2.0
  license_file: flang/LICENSE.TXT
  summary: Flang is a Fortran compiler targeting LLVM.
  dev_url: https://github.com/llvm/llvm-project

extra:
  recipe-maintainers:
    - isuruf
  feedstock-name: flang
